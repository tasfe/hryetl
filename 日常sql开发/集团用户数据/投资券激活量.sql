SELECT
T.COUPON_NO
,T.COUPON_VALUE/100 COUPON_VALUE
,T.USER_ID
,T.ACTIVATE_TIME
,T.EFFECTIVE_DATE
,T.EXPIRED_DATE
,T.USAGE_TIME
,T.USAGE_COMMENTS
,T.BATCH_NO
,(CASE WHEN T1.DATE_KEY IS NULL THEN '无P2P交易用户' WHEN T1.DATE_KEY BETWEEN '20170401' AND '20170430' THEN '新交易用户' ELSE '老交易用户'  END) USER_TYPE
FROM (
SELECT
s0.COUPON_NO
,s0.COUPON_VALUE/100 COUPON_VALUE
,s0.USER_ID
,s0.ACTIVATE_TIME
,s0.EFFECTIVE_DATE
,s0.EXPIRED_DATE
,s0.USAGE_TIME
,s0.USAGE_COMMENTS
,S0.BATCH_NO
FROM BIDATA.s_promo_coupon s0
WHERE S0.BATCH_NO BETWEEN '201704010003' AND '201704010008'
AND s0.ACTIVATE_TIME is not null
UNION ALL
SELECT
S1.COUPON_NO
,S1.COUPON_VALUE/100 COUPON_VALUE
,S1.USER_ID
,S1.ACTIVATE_TIME
,S1.EFFECTIVE_DATE
,S1.EXPIRED_DATE
,S1.USAGE_TIME
,S1.USAGE_COMMENTS
,S0.BATCH_NO
FROM BIDATA.S_PROMO_COUPON_GROUP_ITEM s0
LEFT JOIN BIDATA.S_PROMO_COUPON S1
ON S0.ID=S1.COUPON_GROUP_ITEM_ID
where S0.BATCH_NO BETWEEN '201704010003' AND '201704010008'
AND s1.ACTIVATE_TIME is not null
) T
LEFT JOIN BIDATA.DM_USER_ORDER_FIRST T1
ON T.USER_ID=T1.HRYID
;