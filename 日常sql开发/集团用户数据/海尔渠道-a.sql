WITH TMP_USER_CHANNEL AS (
SELECT
S0.PROMOTER_ID CHANNEL_ID
,DECODE(S0.PROMOTER_ID,'1000000008','日日顺乐家','1000000017','乐家日日顺','1000000009','海尔商城','1000000018','ihaier APP  ','1000000019','海尔BBS ','1000000020','集团屏保','1000000021','海尔集团','1000000024','展会') CHANNEL
,S0.PROMOTED_ID HRYID
FROM BIDATA.S_PROMO_PROMOTION_RELATION S0
WHERE S0.PROMOTER_ID IN ('1000000008','1000000017','1000000009','1000000018','1000000019','1000000020','1000000021','1000000024')
),
TMP_P2P_INVEST AS (
select 
t0.F03 hryid,
count(t0.F01) p2p_order_count,
sum(t0.F05) p2p_invest_amt
from bidata.S_S62_T6250 t0
where t0.F06 < to_date('20170501','yyyymmdd') 
and t0.F07='F'
group by t0.F03
),
TMP_FUND_INVEST AS (
select
t0.f01 hryid,
t0.kjtid,
count(t1.order_id) fund_order_count,
sum(t1.trans_amt)/100 fund_invest_amount
from bidata.s_s61_t6110 t0
left join funduser.t_fund_share_order@fdb t1
on t0.kjtid=t1.kjt_cust_id
where t1.trans_type='I' and t1.status=5 
and t1.create_time < to_date('20170501','yyyymmdd')
group by t0.f01,t0.kjtid
),
TMP_STAFF_USER AS (
select
t1.HRYID hryid
,t0.phone STAFF_PHONE
,t1.AUTHENT_STATUS_NAME VER_STATE
,t1.kjtid
,t1.CTIME created_time
from bidim.obj_staff_phone t0
inner join BIDATA.DIM_USER_HRY_USERS  t1
on t0.phone=t1.HRY_ACCT or t0.phone=t1.MOBILE
where t1.CTIME < to_date('20170501','yyyymmdd')
),
TMP_USER_FIRST_TRADE AS (
SELECT
S0.KJTID
,MIN(S0.RPTDT) FRIST_TRADE_DATE
FROM BIDATA.BI_USER_EXCHANGE S0
WHERE S0.RESYSTEMID != 'KJT'
GROUP BY S0.KJTID
)

SELECT T.CHANNEL_ID,T.CHANNEL,T.USER_TYPE,COUNT(HRYID) USER_COUNT
FROM (
SELECT
S2.CHANNEL_ID
,S2.CHANNEL
,S1.HRYID
,(CASE WHEN S6.HRYID IS NOT NULL THEN '集团员工' ELSE '非集团员工'  END) USER_TYPE
,TO_CHAR(S1.CTIME,'YYYYMMDD') REG_DATE
,S3.DATE_KEY FIRST_P2P_ORDER_DATE
,S7.FRIST_TRADE_DATE 
,S4.p2p_order_count
,S4.p2p_invest_amt
,S5.fund_order_count
,S5.fund_invest_amount
FROM BIDATA.DIM_USER_HRY_USERS S1
INNER JOIN TMP_USER_CHANNEL S2
ON S1.HRYID=S2.HRYID
LEFT JOIN BIDATA.DM_USER_ORDER_FIRST S3
ON S1.HRYID=S3.HRYID
LEFT JOIN TMP_P2P_INVEST S4
ON S1.HRYID=S4.HRYID
LEFT JOIN TMP_FUND_INVEST S5
ON S1.HRYID=S5.HRYID
LEFT JOIN TMP_STAFF_USER S6
ON S1.HRYID=S6.HRYID
LEFT JOIN TMP_USER_FIRST_TRADE S7
ON S1.KJTID=S7.KJTID
) T
WHERE T.FRIST_TRADE_DATE BETWEEN '20170401' AND '20170430'
--WHERE T.REG_DATE BETWEEN '20170401' AND '20170430'
GROUP BY T.CHANNEL_ID,T.CHANNEL,T.USER_TYPE
)
PIVOT (MAX(USER_COUNT) FOR USER_TYPE IN ('非集团员工' AS 非集团员工,'集团员工' AS 集团员工 ))
;